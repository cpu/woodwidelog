<!doctype html><html><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><title>Rock Replace - Wood Wide Log</title><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="Mudlet, NixPkgs Lua Overrides, Bowling."><meta property="og:image" content><meta property="og:title" content="Rock Replace"><meta property="og:description" content="Mudlet, NixPkgs Lua Overrides, Bowling."><meta property="og:type" content="article"><meta property="og:url" content="https://log.woodweb.ca/2022/11/rock-replace/"><meta property="og:image" content="https://log.woodweb.ca/2022/11/rock-replace/feature.jpg"><meta property="article:section" content="posts"><meta property="article:published_time" content="2022-11-09T08:00:00-04:00"><meta property="article:modified_time" content="2022-11-09T08:00:00-04:00"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://log.woodweb.ca/2022/11/rock-replace/feature.jpg"><meta name=twitter:title content="Rock Replace"><meta name=twitter:description content="Mudlet, NixPkgs Lua Overrides, Bowling."><script src=https://log.woodweb.ca/js/feather.min.js></script>
<link href=https://log.woodweb.ca/css/fonts.2c2227b81b1970a03e760aa2e6121cd01f87c88586803cbb282aa224720a765f.css rel=stylesheet><link rel=stylesheet type=text/css media=screen href=https://log.woodweb.ca/css/main.ac08a4c9714baa859217f92f051deb58df2938ec352b506df655005dcaf98cc0.css><link rel=stylesheet type=text/css href=https://log.woodweb.ca/css/custom.5ddc6ca3ae5231a84ed7d87d48dbac9e03a71fa553bd09ab71b3f207786c3b78.css></head><body><div class=content><header><div class=main><a href=https://log.woodweb.ca/>Wood Wide Log</a></div><nav><a href=/>Home</a>
<a href=/posts>Archive</a>
<a href=/about>About</a></nav></header><main><article><div class=title><h1 class=title>Rock Replace</h1><div class=meta>Posted on Nov 9, 2022</div></div><section class=body><p>I hear federation is cool now. If you&rsquo;re reading this, start a blog. It&rsquo;s the
hip old new way to have decentralized shitposts.</p><p><img src=./lakeview.jpg alt="Lake view"></p><h1 id=lately>Lately</h1><p>I&rsquo;m doubling down on writing the world&rsquo;s most niche technology blog and
bringing you another adventure from the intersection of <a href=https://mud.fandom.com/wiki/MUD_client>MUD Clients</a> and
<a href=https://github.com/NixOS/nixpkgs>NixPkgs</a>. Thrills abound, what can I say.</p><h2 id=mudlet>Mudlet</h2><p>This time around I was looking into the <a href=https://mudlet.org/>Mudlet</a> derivation, which seemed to be
stalled at <a href=https://github.com/Mudlet/Mudlet/releases/tag/Mudlet-4.15.1>4.15.1</a> in the unstable NixPkgs channel, while the latest release was
<a href=https://github.com/Mudlet/Mudlet/releases/tag/Mudlet-4.16.0>4.16.0</a>. What was the hold-up? Well, SQLite3 support was broken:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#f92672>[</span> ERROR <span style=color:#f92672>]</span> - Cannot find Lua module sqlite3.
</span></span><span style=display:flex><span>Lua error: error loading module <span style=color:#e6db74>&#39;luasql.sqlite3&#39;</span> from file.
</span></span><span style=display:flex><span><span style=color:#e6db74>&#39;/nix/store/ng8m8g0sddihql99nds5z8amd30qiaig-lua-5.1.5-env/lib/lua/5.1/luasql/sqlite3.so&#39;</span>:
</span></span><span style=display:flex><span>/nix/store/ng8m8g0sddihql99nds5z8amd30qiaig-lua-5.1.5-env/lib/lua/5.1/luasql/sqlite3.so: 
</span></span><span style=display:flex><span>  undefined symbol: lua_isinteger
</span></span><span style=display:flex><span>Database support will not be available.
</span></span></code></pre></div><p>After some digging I had a strong theory for the root cause. For Reasons‚Ñ¢Ô∏è
Mudlet only supports Lua 5.1 and the careful observer will note that the missing
symbol from the error message, <code>lua_isinteger</code>, only appears in the <a href=https://www.lua.org/manual/5.3/manual.html#lua_isinteger>Lua 5.3
API Docs</a>. The <code>LuaSQL-SQLite3</code> <a href=https://luarocks.org/modules/tomasguisasola/luasql-sqlite3>LuaRocks page</a> lists
compatibility with Lua >= 5.1 but a <a href=https://github.com/lunarmodules/luasql/commit/ad59e6bf09b1eab5df02a7bc2bca056222a26030>commit from last year</a> relies
on a Lua 5.3+ C API feature! How hasn&rsquo;t this broken anyone else you might ask?
Simple: the regression hasn&rsquo;t been bundled into a release yet. It&rsquo;s just us
folks on the bleeding edge that are getting cut and NixPkgs at the time of
writing has the library <a href=https://github.com/NixOS/nixpkgs/blob/c588a77cd54fbdbe874ddd1e63656d5fd69c6ae6/pkgs/development/lua-modules/generated-packages.nix#L2164-L2185>pinned at a rev</a> that includes the regression. üî™</p><p>An <a href=https://github.com/lunarmodules/luasql/issues/147>upstream issue</a> was dutifully filed but I wanted to unbreak Mudlet
today. First I considered overriding the LuaRocks rev for the problematic lib
back to before the regression. There&rsquo;s even a <a href=https://github.com/NixOS/nixpkgs/blob/fbec74286dd682720703fc455ec650c0a8552dbf/pkgs/development/lua-modules/overrides.nix#L352-L356>handy
<code>overrides.nix</code></a> for Lua modules that could have been
used for that. I discarded this approach because it would be changing the
version for all of Nixpkgs and the blast radius seemed too high; maybe there are
Lua 5.3 users happy with the more up-to-date package.</p><p>To localize the fix to just Mudlet I <a href=https://github.com/NixOS/nixpkgs/pull/199944/commits/ae5ed8ce226db3913adf7b1107487f53bd8c69da>took a different approach</a>,
using a package override for the Lua derivation used to build the Lua
environment with the dependencies Mudlet requires:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-nix data-lang=nix><span style=display:flex><span>  <span style=color:#f92672>...</span>
</span></span><span style=display:flex><span>  overrideLua <span style=color:#960050;background-color:#1e0010>=</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>let</span>
</span></span><span style=display:flex><span>      packageOverrides <span style=color:#f92672>=</span> self: super: {
</span></span><span style=display:flex><span>        <span style=color:#75715e># luasql-sqlite3 master branch broke compatibility with lua 5.1. Pin to</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e># an earlier commit.</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e># https://github.com/lunarmodules/luasql/issues/147</span>
</span></span><span style=display:flex><span>        luasql-sqlite3 <span style=color:#f92672>=</span> super<span style=color:#f92672>.</span>luaLib<span style=color:#f92672>.</span>overrideLuarocks super<span style=color:#f92672>.</span>luasql-sqlite3
</span></span><span style=display:flex><span>          (drv: {
</span></span><span style=display:flex><span>            version <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;2.6.0-1-custom&#34;</span>;
</span></span><span style=display:flex><span>            src <span style=color:#f92672>=</span> fetchFromGitHub {
</span></span><span style=display:flex><span>              owner <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;lunarmodules&#34;</span>;
</span></span><span style=display:flex><span>              repo <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;luasql&#34;</span>;
</span></span><span style=display:flex><span>              rev <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;8c58fd6ee32faf750daf6e99af015a31402578d1&#34;</span>;
</span></span><span style=display:flex><span>              hash <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;sha256-XlTB5O81yWCrx56m0cXQp7EFzeOyfNeqGbuiYqMrTUk=&#34;</span>;
</span></span><span style=display:flex><span>            };
</span></span><span style=display:flex><span>          });
</span></span><span style=display:flex><span>      };
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>in</span>
</span></span><span style=display:flex><span>    lua<span style=color:#f92672>.</span>override { <span style=color:#66d9ef>inherit</span> packageOverrides; };
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  luaEnv <span style=color:#960050;background-color:#1e0010>=</span> overrideLua<span style=color:#f92672>.</span>withPackages (ps: <span style=color:#66d9ef>with</span> ps; [
</span></span><span style=display:flex><span>    luasql-sqlite3
</span></span><span style=display:flex><span>    <span style=color:#f92672>...</span>
</span></span><span style=display:flex><span>  ]);
</span></span><span style=display:flex><span>  <span style=color:#f92672>...</span>
</span></span></code></pre></div><p>It worked perfectly. üéâ No more undefined symbol trouble and Mudlet 4.16.0 is
<a href="https://search.nixos.org/packages?channel=unstable&show=mudlet&from=0&size=50&sort=relevance&type=packages&query=mudlet">now available</a> in the NixPkgs unstable channel.</p><p><strong>Bonus</strong>: I also fixed the optional integration to let Mudlet set your activity
status in Discord based on the MUD you&rsquo;re playing. Getting that working was just
a matter of wiring a dependency on <code>discord-rpc</code> through to the QT wrapper
<code>LD_LIBRARY_PATH</code>.</p><h1 id=thinking-about>Thinking about</h1><p><img src=./candlepin.png alt="Candlepin Bowling"></p><ul><li><a href=https://en.wikipedia.org/wiki/Candlepin_bowling>Candlepin Bowling</a> - how can you not love a weird bowling variant <a href=https://en.wikipedia.org/wiki/Candlepin_bowling#/media/File:20190514_Candlepin_states_and_provinces.png>nearly
exclusive</a> to the Maritimes. üé≥</li><li><a href=https://wjwh.eu/posts/2021-10-01-no-syscall-server-iouring.html>Stupid tricks with ioring</a>: come for the clickbait title, stay for the
interesting (ab)use of ioring.</li><li><a href=https://fulcicult.bandcamp.com/album/exhumed-information>FULCI</a>: <em>&ldquo;The death metal band named after the Godfather of gore&rdquo;</em>, exactly as
described on the tin, 8/10.</li></ul><h1 id=until-next-time>Until next time</h1><p><img src=./sunset.jpg alt="Sunset view"></p></section><div class=post-tags></div></article></main><footer><div style=display:flex><a class=soc href=https://github.com/cpu/woodwidelog title=GitHub><i data-feather=github></i></a>
<a class=border></a><a class=soc href=https://twitter.com/cpu/ title=Twitter><i data-feather=twitter></i></a>
<a class=border></a></div><div class=footer-info>2022 Daniel McCarney</div></footer><script>feather.replace()</script></div></body></html>